<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Objective-Cã€ŒRuntimeæœºåˆ¶ã€å­¦ä¹ è®°å½• | Jiaqi`s Blog</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://jiaqiwang98.github.io/favicon.ico?v=1636353225781">
<link rel="stylesheet" href="https://jiaqiwang98.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="é˜…è¯»è¿™ç¯‡æ–‡ç« ä½ å°†çŸ¥é“OCæ¶ˆæ¯è½¬å‘çš„ä¸‰æ­¥å¤„ç†å¯ä»¥ç”¨æ¥åšä»€ä¹ˆ

æœ€æ¨èé˜…è¯»ğŸŒŸï¼š
ã€ŠiOS å¼€å‘ï¼šã€Runtimeã€è¯¦è§£ï¼ˆä¸€ï¼‰åŸºç¡€çŸ¥è¯†ã€‹ https://bujige.net/blog/iOS-Runtime-01.html
å…¶ä»–æ¨èé˜…è¯»ï¼š
ã€Š..." />
    <meta name="keywords" content="" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://jiaqiwang98.github.io">
        <img src="https://jiaqiwang98.github.io/images/avatar.png?v=1636353225781" class="site-logo">
        <h1 class="site-title">Jiaqi`s Blog</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      To be a better one.
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://jiaqiwang98.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Objective-Cã€ŒRuntimeæœºåˆ¶ã€å­¦ä¹ è®°å½•</h2>
            <div class="post-date">2021-11-07</div>
            
            <div class="post-content" v-pre>
              <p>é˜…è¯»è¿™ç¯‡æ–‡ç« ä½ å°†çŸ¥é“OCæ¶ˆæ¯è½¬å‘çš„ä¸‰æ­¥å¤„ç†å¯ä»¥ç”¨æ¥åšä»€ä¹ˆ</p>
<!-- more -->
<h3 id="æœ€æ¨èé˜…è¯»">æœ€æ¨èé˜…è¯»ğŸŒŸï¼š</h3>
<p>ã€ŠiOS å¼€å‘ï¼šã€Runtimeã€è¯¦è§£ï¼ˆä¸€ï¼‰åŸºç¡€çŸ¥è¯†ã€‹ https://bujige.net/blog/iOS-Runtime-01.html</p>
<h3 id="å…¶ä»–æ¨èé˜…è¯»">å…¶ä»–æ¨èé˜…è¯»ï¼š</h3>
<p>ã€ŠObjective-C Runtimeã€‹https://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/</p>
<p>ç½‘ç»œä¸Šå…³äºObjective-C Runtimeæ€»ç»“æ–‡ç« éå¸¸å¤šï¼Œæˆ‘è¿™é‡Œå°±å–æœ€æœ€ç²¾åçš„éƒ¨åˆ†ï¼Œåªæ”¾ä¸¤ç¯‡ã€‚å…¶ä¸­ç¬¬ä¸€ç¯‡æ˜¯æˆ‘çœ‹è¿‡çš„æ¡ç†æœ€æ¸…æ™°ï¼Œæœ€æ˜“æ‡‚çš„Runtimeæ–‡ç« ã€‚</p>
<h3 id="æˆ‘çš„å­¦ä¹ ä¸æ€è€ƒ">æˆ‘çš„å­¦ä¹ ä¸æ€è€ƒï¼š</h3>
<p>æˆ‘åœ¨é˜…è¯»ä»‹ç»Runtimeçš„åšå®¢æ—¶å‘ç°ï¼Œæ‰€æœ‰çš„æ–‡ç« éƒ½ä¼šè®²<code>[dog run];</code>è¿™æ ·ä¸€ä¸ªè°ƒç”¨æµç¨‹ï¼ˆä¸äº†è§£Objective-Cè¯­æ³•çš„å¯ä»¥è®¤ä¸ºæ˜¯dogå¯¹è±¡è°ƒç”¨äº†run()å‡½æ•°ï¼‰ï¼š</p>
<blockquote>
<p>é¦–å…ˆä¼šè¿›è¡Œ<strong>æ¶ˆæ¯å‘é€</strong>ï¼Œå»dogå¯¹è±¡æ‰€å±ç±»çš„å‡½æ•°è¡¨(methodLists)ä¸­å»æ‰¾æ˜¯å¦å®ç°äº†runå‡½æ•°ï¼Œå®ç°äº†åˆ™æ‰§è¡Œrunå‡½æ•°ã€‚å¦‚æœæ²¡æœ‰å®ç°runå‡½æ•°ï¼ŒObjective-Cçš„Runtimeåˆ™ä¼šè¿›å…¥<strong>æ¶ˆæ¯è½¬å‘</strong>æµç¨‹ï¼Œè¿›è¡Œ<strong>æ¶ˆæ¯åŠ¨æ€è§£æ</strong>ï¼Œ<strong>æ¶ˆæ¯æ¥å—è€…é‡å®šå‘</strong>ï¼Œ<strong>æ¶ˆæ¯é‡å®šå‘</strong>ä¸‰æ­¥å¤„ç†ï¼Œå¦‚æœè¿™ä¸‰æ­¥å¤„ç†éƒ½å¤±è´¥äº†ï¼Œå°±ä¼šæŠ›å‡ºæˆ‘ä»¬ç†Ÿæ‚‰çš„<code>unrecognized selector sent to instance</code>å¼‚å¸¸ã€‚</p>
</blockquote>
<p>ä½†æ˜¯å´å¾ˆå°‘æœ‰æ–‡ç« æåˆ°æˆ‘ä»¬èƒ½ç”¨æ¶ˆæ¯è½¬å‘çš„è¿™ä¸‰å¤„ç†æ¥åšä»€ä¹ˆã€‚é€šè¿‡é—®ç»„é‡Œçš„å¤§å“¥å’ŒæŸ¥é˜…èµ„æ–™äº†è§£åˆ°ï¼Œ<strong>æ¶ˆæ¯è½¬å‘çš„ä¸‰æ­¥æµç¨‹</strong>åœ¨ä¸šåŠ¡ä¸Šä½¿ç”¨è¾ƒå°‘ï¼Œä¸»è¦ä½¿ç”¨åœ¨ç¨‹åºçš„<strong>crashé˜²æŠ¤</strong>ä¸­ï¼Œè¿™å°±è§£ç­”äº†æˆ‘çš„å›°æƒ‘ã€‚ä¸‹é¢ç”¨ä¸€ä¸ªdemoæ¥å±•ç¤ºä¸‹æ˜¯å¦‚ä½•åˆ©ç”¨æ¶ˆæ¯è½¬å‘æœºåˆ¶å¯¹<code>unrecognized selector sent to instance</code>è¿™ç§crashè¿›è¡Œé˜²æŠ¤çš„ã€‚</p>
<p>å½“<code>[dog run]</code>ä¸­runå‡½æ•°æ²¡æœ‰å®ç°æ—¶ï¼Œæ¶ˆæ¯è½¬å‘ç»™æˆ‘ä»¬æä¾›äº†ä¸‰æ­¥å¤„ç†æ¥æŒ½å›ã€‚<br>
1.åœ¨<strong>æ¶ˆæ¯åŠ¨æ€è§£æ</strong>ä¸­è°ƒç”¨<code>+resolveInstanceMethod:</code>ä¸ºè¯¥ç±»åŠ¨æ€æ·»åŠ å‡½æ•°çš„å®ç°<br>
2.åœ¨<strong>æ¶ˆæ¯æ¥å—è€…é‡å®šå‘</strong>ä¸­è°ƒç”¨<code>-forwardingTargetForSelector:</code>å°†æ¶ˆæ¯è½¬å‘ç»™åˆ«çš„å¯¹è±¡ï¼ˆä»…é™ä¸€ä¸ªï¼‰ï¼Œçœ‹çœ‹taæœ‰æ²¡æœ‰å®ç°runå‡½æ•°<br>
3.åœ¨<strong>æ¶ˆæ¯é‡å®šå‘</strong>ä¸­è°ƒç”¨<code>-forwardInvocation:</code>å°†æ¶ˆæ¯è½¬ç»™å¤šä¸ªå¯¹è±¡ï¼Œå†è¯•ä¸€ä¸‹</p>
<h3 id="demoå®ç°">Demoå®ç°ï¼š</h3>
<p>è¿™é‡Œæˆ‘ä»¬åœ¨ç¬¬2æ­¥è¿›è¡Œæ‹¦æˆªï¼Œä¸ºä»€ä¹ˆæ˜¯åœ¨ç¬¬2æ­¥ï¼Œç½‘æ˜“å‰ç«¯æŠ€æœ¯å›¢é˜Ÿhttps://neyoufan.github.io/2017/01/13/ios/BayMax_HTSafetyGuard/ ç»™äº†åŸå› </p>
<blockquote>
<ol>
<li>+resolveInstanceMethod: éœ€è¦åœ¨ç±»çš„æœ¬èº«ä¸ŠåŠ¨æ€æ·»åŠ å®ƒæœ¬èº«ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯¹äºè¯¥ç±»æœ¬èº«æ¥è¯´å†—ä½™çš„</li>
<li>-forwardInvocation:å¯ä»¥é€šè¿‡NSInvocationçš„å½¢å¼å°†æ¶ˆæ¯è½¬å‘ç»™å¤šä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å…¶å¼€é”€è¾ƒå¤§ï¼Œéœ€è¦åˆ›å»ºæ–°çš„NSInvocationå¯¹è±¡ï¼Œå¹¶ä¸”forwardInvocationçš„å‡½æ•°ç»å¸¸è¢«ä½¿ç”¨è€…è°ƒç”¨ï¼Œæ¥åšå¤šå±‚æ¶ˆæ¯è½¬å‘é€‰æ‹©æœºåˆ¶ï¼Œä¸é€‚åˆå¤šæ¬¡é‡å†™</li>
<li>-forwardingTargetForSelector:å¯ä»¥å°†æ¶ˆæ¯è½¬å‘ç»™ä¸€ä¸ªå¯¹è±¡ï¼Œå¼€é”€è¾ƒå°ï¼Œå¹¶ä¸”è¢«é‡å†™çš„æ¦‚ç‡è¾ƒä½ï¼Œé€‚åˆé‡å†™</li>
</ol>
</blockquote>
<h4 id="1ä¸ºnsobjectæ·»åŠ hookæ‹¦æˆª-forwardingtargetforselector">1.ä¸ºNSObjectæ·»åŠ Hookæ‹¦æˆª<code>-forwardingTargetForSelector:</code></h4>
<p>Hookç”¨äºæ‹¦æˆªç³»ç»Ÿ<code>-forwardingTargetForSelector:</code>çš„æ‰§è¡Œï¼Œæ›¿æ¢ä¸ºæˆ‘ä»¬é‡å†™çš„<code>- (id)crashProtector_forwardingTargetForSelector:</code></p>
<pre><code class="language-Objective-C">#import &quot;NSObject+HookJQ.h&quot;

@implementation NSObject (HookJQ)

+ (void)crashProtectorSwizzlingClass:(Class)class
                    originalSelector:(SEL)originalSelector
                    swizzledSelector:(SEL)swizzledSelector{
    [self swizzlingInstanceMethodWithClass:class originalSelector:originalSelector swizzledSelector:swizzledSelector];
}

- (void)swizzlingInstanceMethodWithClass:(Class)class
                        originalSelector:(SEL)originalSelector
                        swizzledSelector:(SEL)swizzledSelector{
    Method originalMethod = class_getInstanceMethod(class, originalSelector);
    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);

    method_exchangeImplementations(originalMethod, swizzledMethod);
}
@end
</code></pre>
<h4 id="2é‡å†™-forwardingtargetforselectoræ–¹æ³•">2.é‡å†™<code>-forwardingTargetForSelector:</code>æ–¹æ³•</h4>
<p>åŠ¨æ€åˆ›å»ºåä¸ºcrashProtectorClassçš„crashProtectorç±»ï¼Œå¹¶ä¸ºå…¶åŠ¨æ€æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œæ–‡ä¸­çš„æ–¹æ³•ä¼ å…¥ä»€ä¹ˆéƒ½ç›´æ¥è¿”å›0ï¼Œç„¶åæŠŠæ¶ˆæ¯è½¬å‘åˆ°è¿™ä¸ªåŠ¨æ€åˆ›å»ºçš„ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå®Œæˆcrashé˜²æŠ¤ã€‚</p>
<pre><code class="language-Objective-C">#import &quot;NSObject+CrashProtectorJQ.h&quot;
#import &quot;NSObject+HookJQ.h&quot;
@implementation NSObject (CrashProtectorJQ)

+ (void)load{
    //æ‹¦æˆªç³»ç»Ÿçš„æ–¹æ³•ï¼Œæ›¿æ¢æˆæˆ‘ä»¬çš„å®ç°
    [NSObject crashProtectorSwizzlingClass:[NSObject class] originalSelector:@selector(forwardingTargetForSelector:) swizzledSelector:@selector(crashProtector_forwardingTargetForSelector:)];
}

//é‡å†™çš„forwardingTargetForSelector:æ–¹æ³•
- (id)crashProtector_forwardingTargetForSelector:(SEL)aSelector{
    //éšæ„åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»
    Class crashProtectorClass = NSClassFromString(@&quot;crashProtector&quot;);
    if (!crashProtectorClass) {
        crashProtectorClass = objc_allocateClassPair([NSObject class], &quot;crashProtector&quot;, 0);
        //æ³¨å†Œè¯¥ç±»
        objc_registerClassPair(crashProtectorClass);
    }
    //å¦‚æœè¯¥ç±»æ²¡æœ‰å®ç°é‚£ä¸ªæ–¹æ³•ï¼ŒåŠ¨æ€æ·»åŠ ä¸€ä¸ªå®ç°
    if (!class_getInstanceMethod(NSClassFromString(@&quot;crashProtector&quot;), aSelector)) {
        class_addMethod(crashProtectorClass, aSelector, (IMP)crashPro, &quot;@@:@&quot;);
    }
    //è½¬å‘åˆ°crashProtectorçš„å®ä¾‹å¯¹è±¡
    return [crashProtectorClass new];
}
int crashPro(id slf ,SEL selector){
    return 0;
}
@end
</code></pre>
<h4 id="3æµ‹è¯•">3.æµ‹è¯•</h4>
<p>æ–°å»ºä¸€ä¸ªç±»TestObjç»§æ‰¿è‡ªNSObjectï¼Œå£°æ˜thisEmptyMethodæ–¹æ³•ï¼Œä½†ä¸å®ç°</p>
<pre><code class="language-Objective-C">#import &lt;Foundation/Foundation.h&gt;
NS_ASSUME_NONNULL_BEGIN

@interface TestObj : NSObject

- (void)thisEmptyMethod;

@end

@implementation TestObj

@end
</code></pre>
<p>ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä¸ä¼šcrash<br>
<img src="https://jiaqiwang98.github.io/post-images/1636285817532.png" alt="" loading="lazy"></p>
<p>æ³¨é‡Šæ‰crashé˜²æŠ¤æ–¹æ³•ï¼Œå‘ç”Ÿ<code>unrecognized selector sent to instance</code>å¼‚å¸¸ï¼Œç¨‹åºå´©æºƒ<br>
<img src="https://jiaqiwang98.github.io/post-images/1636285926681.png" alt="" loading="lazy"></p>

            </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jiaqiwang98.github.io/post/mei-ri-xue-xi-ji-lu/">
                  <h3 class="post-title">
                    æ¯æ—¥å­¦ä¹ è®°å½•
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
